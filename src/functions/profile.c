#include "profile.h"

ssize_t dev_attr_write_profile(struct device *dev, struct device_attribute *attr, const char *buf, size_t count) {
    struct usb_interface *interface = to_usb_interface(dev->parent);
    struct usb_device *usb_dev = interface_to_usbdev(interface);
    int res;

    unsigned char profile_num = 0x00; // Default value

    sscanf(buf, "%hhu", &profile_num);
    if (res < 1) {
        printk(KERN_INFO "opendragon: Only %d arguments valid, using default values", res);
    }

    res = set_profile(usb_dev, profile_num);
    printk(KERN_INFO "opendragon: Setting profile returned status code %d", res);

    return (ssize_t)count;
}

int set_profile(struct usb_device *dev, unsigned char profile_num) {
    // clang-format off
    unsigned char data[] = {
        0x02, 0xf3, 0x2c, 0x00, 0x02, 0x00, 0x00, 0x00, profile_num, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x02, 0xf1, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0xf1, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0xf1, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0xf1, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    };
    // clang-format on

    return send_redragon_reports(dev, data, DATA_LENGTH, sizeof(data) / sizeof(data[0]) / DATA_LENGTH);
}